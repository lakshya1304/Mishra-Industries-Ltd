<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Order Management | Mishra Industries Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap");
      body {
        font-family: "Plus Jakarta Sans", sans-serif;
      }
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #1e3a8a;
        border-radius: 10px;
      }
      @media print {
        body * {
          visibility: hidden;
        }
        #invoiceContainer,
        #invoiceContainer * {
          visibility: visible;
        }
        #invoiceContainer {
          position: absolute;
          left: 0;
          top: 0;
          width: 100%;
          padding: 40px;
          background: white !important;
        }
        .no-print {
          display: none !important;
        }
      }
    </style>
  </head>
  <body class="bg-slate-50 flex min-h-screen custom-scrollbar">
    <div
      id="invoiceContainer"
      class="hidden bg-white p-12 border border-slate-200"
    >
      <div
        class="flex justify-between items-start border-b-4 border-blue-900 pb-8"
      >
        <div>
          <h1 class="text-4xl font-black text-blue-900">MISHRA INDUSTRIES</h1>
          <p
            class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mt-1"
          >
            Official Industrial Atlas Network
          </p>
          <p class="text-xs mt-4 text-slate-600 font-bold">
            GSTIN: 20ABCDE1234F1Z5
          </p>
        </div>
        <div class="text-right">
          <h2 class="text-2xl font-black text-slate-800 uppercase">
            Tax Invoice
          </h2>
          <p id="invId" class="text-blue-600 font-bold">#MI-000000</p>
          <p id="invDate" class="text-xs text-slate-500 mt-1">
            Date: --/--/----
          </p>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-12 my-10">
        <div>
          <p class="text-[10px] font-black uppercase text-blue-900 mb-2">
            Customer Details:
          </p>
          <p
            id="invCustName"
            class="font-black text-lg text-slate-800 uppercase"
          >
            --
          </p>
          <p id="invCustPhone" class="text-sm text-slate-600 font-bold">--</p>
          <p
            id="invCustAddress"
            class="text-sm text-slate-500 mt-2 italic max-w-xs"
          >
            --
          </p>
        </div>
        <div class="text-right">
          <p class="text-[10px] font-black uppercase text-blue-900 mb-2">
            Payment Summary:
          </p>
          <p id="invPayMethod" class="font-bold text-slate-800 uppercase">
            Method: --
          </p>
          <p id="invTxnId" class="text-[10px] text-slate-400 font-mono mt-1">
            TXN: --
          </p>
          <div
            id="invStatusBadge"
            class="inline-block mt-3 px-4 py-1 rounded-full text-[10px] font-black uppercase"
          >
            --
          </div>
        </div>
      </div>
      <table class="w-full text-left border-collapse">
        <thead>
          <tr class="bg-blue-900 text-white">
            <th class="p-4 text-[10px] uppercase font-black">Sl.</th>
            <th class="p-4 text-[10px] uppercase font-black">
              Item Description
            </th>
            <th class="p-4 text-[10px] uppercase font-black text-center">
              Qty
            </th>
            <th class="p-4 text-[10px] uppercase font-black text-right">
              Price
            </th>
            <th class="p-4 text-[10px] uppercase font-black text-right">
              Total
            </th>
          </tr>
        </thead>
        <tbody id="invItemsBody" class="divide-y divide-slate-100"></tbody>
      </table>
      <div class="mt-10 flex justify-end">
        <div class="w-72 space-y-3">
          <div class="flex justify-between text-sm font-bold text-slate-500">
            <span>Taxable Value</span><span id="invSubtotal">₹0</span>
          </div>
          <div class="flex justify-between text-sm font-bold text-slate-500">
            <span>GST (18%)</span><span id="invGst">₹0</span>
          </div>
          <div
            class="flex justify-between text-2xl font-black text-blue-900 border-t-2 border-blue-900 pt-3"
          >
            <span>Grand Total</span><span id="invGrandTotal">₹0</span>
          </div>
        </div>
      </div>
    </div>

    <div
      id="itemModal"
      class="fixed inset-0 z-[200] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center hidden p-6"
    >
      <div
        class="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl overflow-hidden animate__animated animate__zoomIn"
      >
        <div
          class="bg-blue-900 p-6 text-white flex justify-between items-center"
        >
          <h3 class="font-black uppercase tracking-widest text-sm">
            Order Manifest
          </h3>
          <button onclick="closeItemModal()" class="text-2xl">&times;</button>
        </div>
        <div
          id="modalContent"
          class="p-8 space-y-4 max-h-[60vh] overflow-y-auto custom-scrollbar"
        ></div>
      </div>
    </div>

    <aside
      class="w-72 bg-slate-900 sticky top-0 h-screen text-white p-8 shadow-2xl flex flex-col z-50 no-print"
    >
      <div class="flex items-center space-x-3 mb-12">
        <h2 class="text-2xl font-bold tracking-tighter">
          MISHRA <span class="text-orange-500">INDUSTRIES</span>
        </h2>
      </div>
      <nav class="space-y-3 flex-1">
        <a
          href="site-editor.html"
          class="flex items-center space-x-4 p-4 hover:bg-white/5 rounded-2xl transition-all group"
        >
          <i
            class="fas fa-layer-group text-slate-500 group-hover:text-orange-500"
          ></i>
          <span
            class="font-bold text-sm tracking-wide text-slate-400 group-hover:text-white"
            >Site Editor</span
          >
        </a>
        <a
          href="stock-dashboard.html"
          class="flex items-center space-x-4 p-4 hover:bg-white/5 rounded-2xl transition-all group"
        >
          <i
            class="fas fa-boxes text-slate-500 group-hover:text-orange-500"
          ></i>
          <span
            class="font-bold text-sm tracking-wide text-slate-400 group-hover:text-white"
            >Inventory</span
          >
        </a>
        <a
          href="users.html"
          class="flex items-center space-x-4 p-4 hover:bg-white/5 rounded-2xl transition-all group"
        >
          <i
            class="fas fa-users text-slate-500 group-hover:text-orange-500"
          ></i>
          <span
            class="font-bold text-sm tracking-wide text-slate-400 group-hover:text-white"
            >Users</span
          >
        </a>
        <a
          href="orders.html"
          class="flex items-center space-x-4 p-4 bg-orange-500/10 rounded-2xl transition-all group"
        >
          <i class="fas fa-shopping-cart text-orange-500"></i>
          <span class="font-bold text-sm tracking-wide text-white"
            >Orders List</span
          >
        </a>
      </nav>
      <a
        href="../index.html"
        class="flex items-center space-x-4 p-4 text-slate-500 hover:text-red-400 transition-all border-t border-slate-800"
      >
        <i class="fas fa-sign-out-alt"></i>
        <span class="font-bold text-sm">Logout Console</span>
      </a>
    </aside>

    <main class="flex-1 p-12 overflow-y-auto no-print">
      <header class="flex justify-between items-end mb-12">
        <div>
          <h1
            class="text-5xl font-black text-slate-900 tracking-tighter uppercase"
          >
            Fulfillment
          </h1>
          <p
            class="text-slate-400 font-bold text-xs mt-2 uppercase tracking-[0.3em]"
          >
            Live Order & Billing Stream
          </p>
        </div>
        <div class="flex space-x-4">
          <button
            onclick="downloadOrderReport()"
            class="bg-emerald-600 text-white px-6 py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest hover:bg-emerald-700 transition-all shadow-xl"
          >
            <i class="fas fa-file-excel mr-2"></i> Manifest
          </button>
          <button
            onclick="loadOrders()"
            class="bg-white p-4 rounded-2xl shadow-sm hover:text-orange-500 transition-all border border-slate-100"
          >
            <i class="fas fa-sync-alt"></i>
          </button>
        </div>
      </header>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
        <div
          class="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-sm"
        >
          <p
            class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1"
          >
            Monthly Revenue
          </p>
          <h2 id="monthlyRevenue" class="text-3xl font-black text-blue-900">
            ₹0
          </h2>
          <p
            id="monthName"
            class="text-[9px] font-bold text-orange-500 uppercase mt-2"
          >
            Current Month
          </p>
        </div>
        <div
          class="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-sm"
        >
          <p
            class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1"
          >
            Monthly Orders
          </p>
          <h2 id="monthlyOrders" class="text-3xl font-black text-blue-900">
            0
          </h2>
          <p class="text-[9px] font-bold text-emerald-500 uppercase mt-2">
            Active Volume
          </p>
        </div>
        <div class="bg-blue-900 p-8 rounded-[2.5rem] shadow-xl border-none">
          <p
            class="text-[10px] font-black text-blue-300 uppercase tracking-widest mb-1"
          >
            Lifetime Revenue
          </p>
          <h2 id="lifetimeRevenue" class="text-3xl font-black text-white">
            ₹0
          </h2>
          <p
            class="text-[9px] font-bold text-orange-400 uppercase mt-2 tracking-widest"
          >
            Gross Platform Value
          </p>
        </div>
      </div>

      <section
        class="bg-white rounded-[3rem] shadow-xl border border-slate-100 overflow-hidden"
      >
        <table class="w-full text-left border-collapse">
          <thead class="bg-slate-50 border-b">
            <tr
              class="text-[10px] font-black text-slate-400 uppercase tracking-widest"
            >
              <th class="p-8">Order Info</th>
              <th class="p-8">Customer & Address</th>
              <th class="p-8">Payment & TXN</th>
              <th class="p-8">Status</th>
              <th class="p-8 text-right">Operations</th>
            </tr>
          </thead>
          <tbody id="orderTableBody" class="divide-y divide-slate-50"></tbody>
        </table>
      </section>
    </main>

    <script>
      const API_BASE =
        "https://mishra-industries-ltd-yjfr.onrender.com/api/orders";
      let allOrders = [];
      const user = JSON.parse(localStorage.getItem("mishraUser"));

      // REMOVED frontend strict check for admin role
      if (!user || !user.token) {
        window.location.href = "../login.html";
      }

      async function loadOrders() {
        const tableBody = document.getElementById("orderTableBody");
        tableBody.innerHTML = `<tr><td colspan="5" class="p-20 text-center"><i class="fas fa-circle-notch fa-spin text-orange-500 text-3xl"></i></td></tr>`;
        try {
          // Send Bearer token to connect to Atlas database
          const res = await fetch(`${API_BASE}/all`, {
            headers: {
              Authorization: `Bearer ${user.token}`,
              "Content-Type": "application/json",
            },
          });

          if (!res.ok) throw new Error("Connection failed.");

          allOrders = await res.json();
          calculateStats(allOrders);
          renderOrders(allOrders);
        } catch (err) {
          console.error(err);
          tableBody.innerHTML = `<tr><td colspan="5" class="p-20 text-center text-red-500 font-bold uppercase tracking-widest">DATABASE CONNECTION FAILED: CHECK BACKEND LOGS</td></tr>`;
        }
      }

      function calculateStats(orders) {
        const now = new Date();
        const monthlyData = orders.filter((o) => {
          const d = new Date(o.createdAt);
          return (
            d.getMonth() === now.getMonth() &&
            d.getFullYear() === now.getFullYear()
          );
        });
        const lifetimeTotal = orders.reduce(
          (sum, o) => sum + (o.totalAmount || 0),
          0,
        );
        const monthlyTotal = monthlyData.reduce(
          (sum, o) => sum + (o.totalAmount || 0),
          0,
        );

        document.getElementById("monthlyRevenue").innerText =
          `₹${monthlyTotal.toLocaleString()}`;
        document.getElementById("monthlyOrders").innerText = monthlyData.length;
        document.getElementById("lifetimeRevenue").innerText =
          `₹${lifetimeTotal.toLocaleString()}`;
        document.getElementById("monthName").innerText = now.toLocaleString(
          "default",
          { month: "long", year: "numeric" },
        );
      }

      function renderOrders(orders) {
        const tableBody = document.getElementById("orderTableBody");
        tableBody.innerHTML = "";
        orders.forEach((order) => {
          const orderDate = new Date(order.createdAt).toLocaleDateString(
            "en-IN",
            { day: "2-digit", month: "short", year: "numeric" },
          );
          const payMode = order.paymentMethod || "COD";
          const statusColors = {
            Pending:
              "bg-amber-100 text-amber-600 hover:bg-emerald-500 hover:text-white cursor-pointer",
            Paid: "bg-emerald-100 text-emerald-600 border-emerald-200",
            Shipped: "bg-blue-100 text-blue-600 border-blue-200",
            Delivered: "bg-slate-100 text-slate-400",
          };

          tableBody.innerHTML += `
            <tr class="hover:bg-slate-50 transition-all">
                <td class="p-8">
                    <p class="text-[9px] font-black text-slate-300 mb-1">#MI-${order._id.slice(-6).toUpperCase()}</p>
                    <p class="text-[10px] font-black text-blue-900 uppercase">${orderDate}</p>
                    <button onclick="viewItems('${order._id}')" class="mt-2 px-3 py-1 bg-blue-50 text-blue-600 rounded-lg text-[8px] font-black uppercase hover:bg-blue-600 hover:text-white transition-all">
                       <i class="fas fa-eye mr-1"></i> View Items
                    </button>
                </td>
                <td class="p-8">
                    <p class="font-black text-slate-800 uppercase text-sm">${order.customerName}</p>
                    <p class="text-[10px] font-bold text-slate-400 mb-2">${order.phone}</p>
                    <p class="text-[9px] text-slate-500 bg-slate-100 px-2 py-1 rounded-lg inline-block max-w-[200px] truncate"><i class="fas fa-map-marker-alt mr-1"></i> ${order.address}</p>
                </td>
                <td class="p-8">
                    <p class="font-black text-xl text-blue-900 tracking-tighter">₹${(order.totalAmount || 0).toLocaleString()}</p>
                    <div class="mt-1 flex flex-col gap-0.5">
                        <span class="text-[8px] font-black uppercase text-blue-600">${payMode}</span>
                        <span class="text-[9px] font-mono font-bold text-slate-400 break-all leading-tight">TXN: ${order.transactionId || "N/A"}</span>
                    </div>
                </td>
                <td class="p-8">
                    <span onclick="togglePaidStatus('${order._id}', '${order.status}')" class="${statusColors[order.status] || statusColors.Pending} border text-[8px] font-black px-3 py-1.5 rounded-full uppercase tracking-widest">
                          ${order.status || "Pending"}
                    </span>
                </td>
                <td class="p-8 text-right flex justify-end space-x-2 pt-14">
                    <button onclick="shipAndNotify('${order._id}')" class="bg-blue-900 text-white px-5 py-2.5 rounded-xl text-[9px] font-black uppercase tracking-widest hover:bg-emerald-600 transition-all shadow-lg">Ship</button>
                    <button onclick="generateBill('${order._id}')" class="bg-slate-100 text-blue-900 border border-slate-200 px-5 py-2.5 rounded-xl text-[9px] font-black uppercase tracking-widest hover:bg-blue-900 hover:text-white transition-all">Bill</button>
                    <button onclick="deleteOrder('${order._id}')" class="bg-red-50 text-red-400 p-3 rounded-xl hover:bg-red-500 hover:text-white transition-all shadow-sm"><i class="fas fa-trash-alt"></i></button>
                </td>
            </tr>`;
        });
      }

      async function togglePaidStatus(id, currentStatus) {
        if (currentStatus !== "Pending") return;
        if (!confirm("Mark this order as PAID?")) return;
        try {
          const res = await fetch(`${API_BASE}/status/${id}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${user.token}`,
            },
            body: JSON.stringify({ status: "Paid" }),
          });
          if (res.ok) loadOrders();
        } catch (err) {
          alert("Status Update Failed");
        }
      }

      async function shipAndNotify(id) {
        const order = allOrders.find((o) => o._id === id);
        if (!order) return;
        try {
          const res = await fetch(`${API_BASE}/status/${id}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${user.token}`,
            },
            body: JSON.stringify({ status: "Shipped" }),
          });
          if (res.ok) {
            const orderRef = `#MI-${order._id.slice(-6).toUpperCase()}`;
            const msg = encodeURIComponent(
              `*Mishra Industries Shipment*\n\nDear ${order.customerName},\nYour order ${orderRef} has been shipped!\n\nThank you.`,
            );
            window.open(`https://wa.me/91${order.phone}?text=${msg}`, "_blank");
            loadOrders();
          }
        } catch (err) {
          alert("Shipping Sync Failed");
        }
      }

      function viewItems(id) {
        const order = allOrders.find((o) => o._id === id);
        document.getElementById("modalContent").innerHTML = order.items
          .map(
            (i) => `
              <div class="flex justify-between items-center p-4 bg-slate-50 rounded-2xl">
                  <div><p class="font-black text-blue-900 text-sm">${i.name}</p><p class="text-[10px] font-bold text-slate-400 uppercase">Rate: ₹${(i.price || 0).toLocaleString()}</p></div>
                  <div class="text-right"><p class="text-xs font-black text-blue-900">Qty: ${i.quantity}</p><p class="text-xs font-black text-orange-500">₹${((i.price || 0) * i.quantity).toLocaleString()}</p></div>
              </div>`,
          )
          .join("");
        document.getElementById("itemModal").classList.remove("hidden");
      }

      function closeItemModal() {
        document.getElementById("itemModal").classList.add("hidden");
      }

      function generateBill(id) {
        const order = allOrders.find((o) => o._id === id);
        if (!order) return;
        document.getElementById("invId").innerText =
          `#MI-${order._id.slice(-6).toUpperCase()}`;
        document.getElementById("invDate").innerText =
          `Date: ${new Date(order.createdAt).toLocaleDateString("en-GB")}`;
        document.getElementById("invCustName").innerText = order.customerName;
        document.getElementById("invCustPhone").innerText =
          `Phone: ${order.phone}`;
        document.getElementById("invCustAddress").innerText = order.address;
        document.getElementById("invPayMethod").innerText =
          `Method: ${order.paymentMethod || "COD"}`;
        document.getElementById("invTxnId").innerText =
          `TXN ID: ${order.transactionId || "N/A"}`;

        const badge = document.getElementById("invStatusBadge");
        badge.innerText =
          (
            order.status === "Paid" ||
            order.status === "Shipped" ||
            order.status === "Delivered"
          ) ?
            "PAYMENT RECEIVED"
          : "PAYMENT DUE";
        badge.className = `inline-block mt-3 px-4 py-1 rounded-full text-[10px] font-black uppercase ${badge.innerText === "PAYMENT RECEIVED" ? "bg-green-100 text-green-700" : "bg-orange-100 text-orange-700"}`;

        const subtotal = (order.totalAmount || 0) / 1.18;
        const gst = (order.totalAmount || 0) - subtotal;
        document.getElementById("invItemsBody").innerHTML = (order.items || [])
          .map(
            (item, i) => `
              <tr><td class="p-4 text-xs text-slate-400 font-bold">${i + 1}</td><td class="p-4 text-xs font-bold text-slate-800">${item.name}</td><td class="p-4 text-xs text-center font-bold text-slate-600">${item.quantity}</td><td class="p-4 text-xs text-right text-slate-600">₹${(item.price || 0).toLocaleString()}</td><td class="p-4 text-xs font-black text-blue-900 text-right">₹${((item.price || 0) * item.quantity).toLocaleString()}</td></tr>`,
          )
          .join("");

        document.getElementById("invSubtotal").innerText =
          `₹${subtotal.toLocaleString(undefined, { maximumFractionDigits: 2 })}`;
        document.getElementById("invGst").innerText =
          `₹${gst.toLocaleString(undefined, { maximumFractionDigits: 2 })}`;
        document.getElementById("invGrandTotal").innerText =
          `₹${(order.totalAmount || 0).toLocaleString()}`;

        const inv = document.getElementById("invoiceContainer");
        inv.classList.remove("hidden");
        window.print();
        inv.classList.add("hidden");
      }

      async function deleteOrder(id) {
        if (!confirm("⚠️ Permanently delete this order from Atlas database?"))
          return;
        try {
          const res = await fetch(`${API_BASE}/delete/${id}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${user.token}` },
          });
          if (res.ok) {
            alert("✅ Success: Order removed.");
            loadOrders();
          } else {
            const err = await res.json();
            alert("❌ Server Error: " + err.message);
          }
        } catch (err) {
          alert("❌ Atlas Connection Offline.");
        }
      }

      function downloadOrderReport() {
        if (allOrders.length === 0) return alert("No data available.");
        const report = allOrders.map((o, index) => ({
          "Sl No.": index + 1,
          "Order ID": `MI-${o._id.slice(-6).toUpperCase()}`,
          Date: new Date(o.createdAt).toLocaleDateString(),
          Customer: o.customerName,
          Phone: o.phone,
          Address: o.address,
          Method: o.paymentMethod || "COD",
          "Total (₹)": o.totalAmount,
          Status: o.status || "Pending",
        }));
        const ws = XLSX.utils.json_to_sheet(report);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Orders");
        XLSX.writeFile(
          wb,
          `Mishra_Manifest_${new Date().toISOString().split("T")[0]}.xlsx`,
        );
      }

      document.addEventListener("DOMContentLoaded", loadOrders);
    </script>
  </body>
</html>
