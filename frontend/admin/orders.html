<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Order Management | Mishra Industries Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap");
      body {
        font-family: "Plus Jakarta Sans", sans-serif;
        overflow-x: hidden;
      }
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #1e3a8a;
        border-radius: 10px;
      }

      /* Mobile Nav Logic */
      #mobileNav {
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        transform: translateY(-110%);
      }
      #mobileNav.active {
        transform: translateY(0);
      }

      /* Professional Invoice Print Layout */
      @media print {
        body * {
          visibility: hidden;
        }
        #invoiceContainer,
        #invoiceContainer * {
          visibility: visible;
        }
        #invoiceContainer {
          position: absolute;
          left: 0;
          top: 0;
          width: 100%;
          padding: 40px;
          background: white !important;
        }
        .no-print {
          display: none !important;
        }
      }
    </style>
  </head>
  <body class="bg-slate-50 lg:flex min-h-screen custom-scrollbar">
    <div
      id="invoiceContainer"
      class="hidden bg-white p-12 border border-slate-200"
    >
      <div
        class="flex justify-between items-start border-b-4 border-blue-900 pb-8"
      >
        <div>
          <h1 class="text-4xl font-black text-blue-900">MISHRA INDUSTRIES</h1>
          <p
            class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mt-1"
          >
            Official Industrial Atlas Network
          </p>
          <p class="text-xs mt-4 text-slate-600 font-bold">
            GSTIN: 20ABCDE1234F1Z5
          </p>
        </div>
        <div class="text-right">
          <h2 class="text-2xl font-black text-slate-800 uppercase">
            Tax Invoice
          </h2>
          <p id="invId" class="text-blue-600 font-bold">#MI-000000</p>
          <p id="invDate" class="text-xs text-slate-500 mt-1">
            Date: --/--/----
          </p>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-12 my-10">
        <div>
          <p class="text-[10px] font-black uppercase text-blue-900 mb-2">
            Customer Details:
          </p>
          <p
            id="invCustName"
            class="font-black text-lg text-slate-800 uppercase"
          >
            --
          </p>
          <p id="invCustPhone" class="text-sm text-slate-600 font-bold">--</p>
          <p
            id="invCustAddress"
            class="text-sm text-slate-500 mt-2 italic max-w-xs"
          >
            --
          </p>
        </div>
        <div class="text-right">
          <p class="text-[10px] font-black uppercase text-blue-900 mb-2">
            Payment Summary:
          </p>
          <p id="invPayMethod" class="font-bold text-slate-800 uppercase">
            Method: --
          </p>
          <p id="invTxnId" class="text-[10px] text-slate-400 font-mono mt-1">
            TXN: --
          </p>
          <div
            id="invStatusBadge"
            class="inline-block mt-3 px-4 py-1 rounded-full text-[10px] font-black uppercase"
          >
            --
          </div>
        </div>
      </div>
      <table class="w-full text-left border-collapse">
        <thead>
          <tr class="bg-blue-900 text-white">
            <th class="p-4 text-[10px] uppercase font-black">Sl.</th>
            <th class="p-4 text-[10px] uppercase font-black">
              Item Description
            </th>
            <th class="p-4 text-[10px] uppercase font-black text-center">
              Qty
            </th>
            <th class="p-4 text-[10px] uppercase font-black text-right">
              Price
            </th>
            <th class="p-4 text-[10px] uppercase font-black text-right">
              Total
            </th>
          </tr>
        </thead>
        <tbody id="invItemsBody" class="divide-y divide-slate-100"></tbody>
      </table>
      <div class="mt-10 flex justify-end">
        <div class="w-72 space-y-3">
          <div class="flex justify-between text-sm font-bold text-slate-500">
            <span>Taxable Value</span><span id="invSubtotal">₹0</span>
          </div>
          <div class="flex justify-between text-sm font-bold text-slate-500">
            <span>GST (18% Statutory)</span><span id="invGst">₹0</span>
          </div>
          <div
            class="flex justify-between text-2xl font-black text-blue-900 border-t-2 border-blue-900 pt-3"
          >
            <span>Grand Total</span><span id="invGrandTotal">₹0</span>
          </div>
        </div>
      </div>
    </div>

    <aside
      class="hidden lg:flex w-72 bg-slate-900 sticky top-0 h-screen text-white p-8 shadow-2xl flex-col shrink-0 no-print"
    >
      <div class="flex items-center space-x-3 mb-12">
        <h2 class="text-2xl font-bold tracking-tighter">
          MISHRA <span class="text-orange-500">INDUSTRIES</span>
        </h2>
      </div>
      <nav class="space-y-3 flex-1">
        <a
          href="site-editor.html"
          class="flex items-center space-x-4 p-4 hover:bg-white/5 rounded-2xl transition-all group"
        >
          <i
            class="fas fa-layer-group text-slate-500 group-hover:text-orange-500"
          ></i>
          <span class="font-bold text-sm text-slate-400 group-hover:text-white"
            >Site Editor</span
          >
        </a>
        <a
          href="stock-dashboard.html"
          class="flex items-center space-x-4 p-4 hover:bg-white/5 rounded-2xl transition-all group"
        >
          <i
            class="fas fa-boxes text-slate-500 group-hover:text-orange-500"
          ></i>
          <span class="font-bold text-sm text-slate-400 group-hover:text-white"
            >Inventory</span
          >
        </a>
        <a
          href="users.html"
          class="flex items-center space-x-4 p-4 hover:bg-white/5 rounded-2xl transition-all group"
        >
          <i
            class="fas fa-users text-slate-500 group-hover:text-orange-500"
          ></i>
          <span class="font-bold text-sm text-slate-400 group-hover:text-white"
            >Users</span
          >
        </a>
        <a
          href="orders.html"
          class="flex items-center space-x-4 p-4 bg-orange-500/10 rounded-2xl transition-all group"
        >
          <i class="fas fa-shopping-cart text-orange-500"></i>
          <span class="font-bold text-sm text-white">Orders List</span>
        </a>
        <a
          href="queries.html"
          class="flex items-center space-x-4 p-4 hover:bg-white/5 rounded-2xl transition-all group"
        >
          <i
            class="fas fa-question-circle text-slate-500 group-hover:text-orange-500"
          ></i>
          <span class="font-bold text-sm text-slate-400 group-hover:text-white"
            >Query</span
          >
        </a>
      </nav>
      <a
        href="../index.html"
        class="flex items-center space-x-4 p-4 text-slate-500 hover:text-red-400 transition-all border-t border-slate-800"
      >
        <i class="fas fa-sign-out-alt"></i>
        <span class="font-bold text-sm">Logout Console</span>
      </a>
    </aside>

    <div
      class="lg:hidden w-full bg-slate-900 p-5 flex justify-between items-center sticky top-0 z-[2500] no-print"
    >
      <h2 class="text-white font-bold tracking-tighter">
        MISHRA <span class="text-orange-500">IND.</span>
      </h2>
      <button
        onclick="toggleMobileMenu()"
        class="text-white text-2xl focus:outline-none"
      >
        <i id="menuIcon" class="fas fa-bars"></i>
      </button>
    </div>

    <div
      id="mobileNav"
      class="lg:hidden fixed top-0 left-0 w-full bg-slate-900 z-[2400] pt-20 pb-10 px-6 shadow-2xl border-b border-white/10 no-print"
    >
      <nav class="flex flex-col space-y-4 text-center">
        <a
          href="site-editor.html"
          class="text-slate-300 font-bold py-3 border-b border-white/5"
          >Site Editor</a
        >
        <a
          href="stock-dashboard.html"
          class="text-slate-300 font-bold py-3 border-b border-white/5"
          >Inventory</a
        >
        <a
          href="users.html"
          class="text-slate-300 font-bold py-3 border-b border-white/5"
          >Users</a
        >
        <a
          href="orders.html"
          class="text-orange-500 font-bold py-3 border-b border-white/5"
          >Orders List</a
        >
        <a href="../index.html" class="text-red-400 font-bold py-3"
          >Exit Admin</a
        >
      </nav>
    </div>

    <main class="flex-1 p-6 md:p-12 overflow-x-hidden no-print">
      <header
        class="flex flex-col md:flex-row justify-between items-start md:items-end mb-10 gap-6 animate__animated animate__fadeIn"
      >
        <div>
          <h1
            class="text-4xl md:text-5xl font-black text-slate-900 tracking-tighter uppercase leading-none"
          >
            Fulfillment
          </h1>
          <p
            class="text-slate-400 font-bold text-[10px] mt-2 uppercase tracking-[0.3em]"
          >
            Live Order & Billing Stream
          </p>
        </div>
        <div class="flex gap-3 w-full md:w-auto">
          <button
            onclick="downloadOrderReport()"
            class="flex-1 md:flex-none bg-emerald-600 text-white px-6 py-4 rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-emerald-700 transition-all shadow-lg"
          >
            <i class="fas fa-file-excel mr-2"></i> Manifest
          </button>
          <button
            onclick="loadOrders()"
            class="bg-white p-4 rounded-xl shadow-sm hover:text-orange-500 transition-all border border-slate-100"
          >
            <i class="fas fa-sync-alt"></i>
          </button>
        </div>
      </header>

      <section
        class="bg-white rounded-3xl shadow-xl border border-slate-100 overflow-hidden"
      >
        <div class="overflow-x-auto">
          <table class="w-full text-left min-w-[900px]">
            <thead class="bg-slate-50 border-b">
              <tr
                class="text-[10px] font-black text-slate-400 uppercase tracking-widest"
              >
                <th class="p-8">Order Info</th>
                <th class="p-8">Customer & Address</th>
                <th class="p-8">Payment Details</th>
                <th class="p-8">Status</th>
                <th class="p-8 text-right">Operations</th>
              </tr>
            </thead>
            <tbody id="orderTableBody" class="divide-y divide-slate-50"></tbody>
          </table>
        </div>
      </section>
    </main>

    <script>
      const API_BASE =
        "https://mishra-industries-ltd-yjfr.onrender.com/api/orders";
      let allOrders = [];

      function toggleMobileMenu() {
        const nav = document.getElementById("mobileNav");
        const icon = document.getElementById("menuIcon");
        nav.classList.toggle("active");
        icon.className =
          nav.classList.contains("active") ? "fas fa-times" : "fas fa-bars";
        document.body.style.overflow =
          nav.classList.contains("active") ? "hidden" : "auto";
      }

      async function loadOrders() {
        const tableBody = document.getElementById("orderTableBody");
        tableBody.innerHTML = `<tr><td colspan="5" class="p-20 text-center"><i class="fas fa-circle-notch fa-spin text-orange-500 text-3xl"></i></td></tr>`;
        try {
          const res = await fetch(`${API_BASE}/all`);
          allOrders = await res.json();
          renderOrders(allOrders);
        } catch (err) {
          tableBody.innerHTML = `<tr><td colspan="5" class="p-20 text-center text-red-500 font-bold">DATABASE OFFLINE</td></tr>`;
        }
      }

      function renderOrders(orders) {
        const tableBody = document.getElementById("orderTableBody");
        tableBody.innerHTML = "";
        orders.forEach((order) => {
          const orderDate = new Date(order.createdAt).toLocaleDateString(
            "en-IN",
            { day: "2-digit", month: "short", year: "numeric" },
          );
          const payMode = order.paymentMethod || "COD";
          const statusColors = {
            Pending: "bg-amber-100 text-amber-600 border-amber-200",
            Paid: "bg-emerald-100 text-emerald-600 border-emerald-200",
            Shipped: "bg-blue-100 text-blue-600 border-blue-200",
            Delivered: "bg-slate-100 text-slate-400",
          };

          tableBody.innerHTML += `
            <tr class="hover:bg-slate-50/80 transition-all group">
                <td class="p-8">
                    <p class="text-[9px] font-black text-slate-300 mb-1">#MI-${order._id.slice(-6).toUpperCase()}</p>
                    <p class="text-[10px] font-black text-blue-900 uppercase">${orderDate}</p>
                    <p class="text-[8px] font-bold text-slate-400 mt-1 uppercase tracking-tighter">${order.items.length} Items Ordered</p>
                </td>
                <td class="p-8">
                    <p class="font-black text-slate-800 uppercase text-sm">${order.customerName}</p>
                    <p class="text-[10px] font-bold text-slate-400 mt-1 mb-2"><i class="fas fa-phone-alt mr-1"></i> ${order.phone}</p>
                    <p class="text-[9px] text-slate-500 bg-slate-100 px-2 py-1 rounded-lg inline-block max-w-[200px] truncate"><i class="fas fa-map-marker-alt mr-1 text-orange-500"></i> ${order.address}</p>
                </td>
                <td class="p-8">
                    <p class="font-black text-xl text-blue-900 tracking-tighter">₹${order.totalAmount.toLocaleString()}</p>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="text-[8px] font-black uppercase px-2 py-0.5 rounded bg-blue-50 text-blue-600">${payMode}</span>
                        <span class="text-[8px] font-bold text-slate-300 truncate max-w-[80px]">ID: ${order.transactionId || "N/A"}</span>
                    </div>
                </td>
                <td class="p-8">
                    <span class="${statusColors[order.status] || statusColors.Pending} border text-[8px] font-black px-3 py-1.5 rounded-full uppercase tracking-widest">${order.status || "Pending"}</span>
                </td>
                <td class="p-8 text-right">
                    <div class="flex justify-end space-x-2">
                        <button onclick="generateBill('${order._id}')" class="bg-blue-900 text-white px-5 py-2.5 rounded-xl text-[9px] font-black uppercase tracking-widest hover:bg-orange-600 transition-all shadow-lg">
                            <i class="fas fa-file-invoice mr-2"></i> Bill
                        </button>
                        <button onclick="deleteOrder('${order._id}')" class="bg-red-50 text-red-400 p-3 rounded-xl hover:bg-red-500 hover:text-white transition-all">
                            <i class="fas fa-trash-alt text-xs"></i>
                        </button>
                    </div>
                </td>
            </tr>`;
        });
      }

      function generateBill(id) {
        const order = allOrders.find((o) => o._id === id);
        if (!order) return;
        document.getElementById("invId").innerText =
          `#MI-${order._id.slice(-6).toUpperCase()}`;
        document.getElementById("invDate").innerText =
          `Date: ${new Date(order.createdAt).toLocaleDateString("en-GB")}`;
        document.getElementById("invCustName").innerText = order.customerName;
        document.getElementById("invCustPhone").innerText =
          `Phone: ${order.phone}`;
        document.getElementById("invCustAddress").innerText = order.address;
        document.getElementById("invPayMethod").innerText =
          `Method: ${order.paymentMethod || "COD"}`;
        document.getElementById("invTxnId").innerText =
          `TXN ID: ${order.transactionId || "N/A"}`;
        const badge = document.getElementById("invStatusBadge");
        badge.innerText =
          order.status === "Paid" || order.paymentMethod === "Razorpay" ?
            "PAYMENT RECEIVED"
          : "PAYMENT DUE";
        badge.className = `inline-block mt-3 px-4 py-1 rounded-full text-[10px] font-black uppercase ${order.status === "Paid" ? "bg-green-100 text-green-700" : "bg-orange-100 text-orange-700"}`;
        const subtotal = order.totalAmount / 1.18;
        const gst = order.totalAmount - subtotal;
        document.getElementById("invItemsBody").innerHTML = order.items
          .map(
            (item, i) => `
            <tr>
                <td class="p-4 text-xs text-slate-400 font-bold">${i + 1}</td>
                <td class="p-4 text-xs font-bold text-slate-800">${item.name}</td>
                <td class="p-4 text-xs text-center font-bold text-slate-600">${item.quantity}</td>
                <td class="p-4 text-xs text-right text-slate-600">₹${item.price.toLocaleString()}</td>
                <td class="p-4 text-xs font-black text-blue-900 text-right">₹${(item.price * item.quantity).toLocaleString()}</td>
            </tr>`,
          )
          .join("");
        document.getElementById("invSubtotal").innerText =
          `₹${subtotal.toLocaleString(undefined, { maximumFractionDigits: 2 })}`;
        document.getElementById("invGst").innerText =
          `₹${gst.toLocaleString(undefined, { maximumFractionDigits: 2 })}`;
        document.getElementById("invGrandTotal").innerText =
          `₹${order.totalAmount.toLocaleString()}`;
        const inv = document.getElementById("invoiceContainer");
        inv.classList.remove("hidden");
        window.print();
        inv.classList.add("hidden");
      }

      async function deleteOrder(id) {
        if (!confirm("Permanently delete this order?")) return;
        const res = await fetch(`${API_BASE}/delete/${id}`, {
          method: "DELETE",
        });
        if (res.ok) loadOrders();
      }

      function downloadOrderReport() {
        const report = allOrders.map((o) => ({
          Date: new Date(o.createdAt).toLocaleDateString(),
          Customer: o.customerName,
          Phone: o.phone,
          Address: o.address,
          Total: o.totalAmount,
          Payment: o.paymentMethod,
          Status: o.status,
        }));
        const ws = XLSX.utils.json_to_sheet(report);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Orders");
        XLSX.writeFile(
          wb,
          `Mishra_Orders_${new Date().toISOString().split("T")[0]}.xlsx`,
        );
      }

      document.addEventListener("DOMContentLoaded", loadOrders);
    </script>
  </body>
</html>
