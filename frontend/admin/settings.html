<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>System Console | Mishra Industries</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap");
      body {
        font-family: "Plus Jakarta Sans", sans-serif;
        background: #f8fafc;
      }
      .glass-card {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.3);
      }
      .stat-card:hover {
        transform: translateY(-5px);
        transition: all 0.3s ease;
      }
      .fade-out {
        opacity: 0;
        transition: opacity 0.5s ease-out;
      }
    </style>
  </head>
  <body class="min-h-screen pb-20">
    <button
      onclick="handleLogout()"
      class="flex items-center space-x-2 bg-red-50/10 hover:bg-red-600 text-red-500 hover:text-white px-6 py-3 rounded-2xl transition-all duration-300 border border-red-500/20 group"
    >
      <i
        class="fas fa-sign-out-alt group-hover:rotate-12 transition-transform"
      ></i>
      <span class="text-[10px] font-black uppercase tracking-widest"
        >Back to website</span
      >
    </button>
    <div class="max-w-5xl mx-auto py-12 px-6">
      <div
        class="flex flex-col md:flex-row justify-between items-start md:items-center mb-12 gap-6"
      >
        <div>
          <h1
            class="text-4xl font-black text-blue-900 uppercase tracking-tighter"
          >
            System Console
          </h1>
          <p
            class="text-slate-400 text-xs font-bold uppercase tracking-widest mt-1"
          >
            Live Database Control & Analytics
          </p>
        </div>
        <div
          class="flex items-center space-x-3 bg-white px-6 py-3 rounded-2xl shadow-sm border border-slate-100"
        >
          <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
          <span
            class="text-[10px] font-black text-slate-500 uppercase tracking-widest"
            >Atlas Connected</span
          >
        </div>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-12">
        <div
          class="stat-card bg-blue-900 p-8 rounded-[3rem] text-white shadow-xl relative overflow-hidden"
        >
          <i
            class="fas fa-wallet absolute -right-4 -bottom-4 text-8xl text-blue-800 opacity-40"
          ></i>
          <p
            class="text-[9px] font-black uppercase tracking-widest mb-2 opacity-60"
          >
            Gross Revenue
          </p>
          <h2 id="totalRevenue" class="text-4xl font-black tracking-tighter">
            ₹0
          </h2>
        </div>
        <div
          class="stat-card bg-white p-8 rounded-[3rem] border border-slate-200 shadow-sm relative overflow-hidden"
        >
          <i
            class="fas fa-shopping-bag absolute -right-4 -bottom-4 text-8xl text-slate-50 opacity-50"
          ></i>
          <p
            class="text-[9px] font-black uppercase tracking-widest mb-2 text-slate-400"
          >
            Lifetime Orders
          </p>
          <h2
            id="totalOrders"
            class="text-4xl font-black text-blue-900 tracking-tighter"
          >
            0
          </h2>
        </div>
        <div
          class="stat-card bg-orange-500 p-8 rounded-[3rem] text-white shadow-xl relative overflow-hidden"
        >
          <i
            class="fas fa-box-open absolute -right-4 -bottom-4 text-8xl text-orange-400 opacity-40"
          ></i>
          <p
            class="text-[9px] font-black uppercase tracking-widest mb-2 opacity-60"
          >
            Active Inventory
          </p>
          <h2 id="totalProducts" class="text-4xl font-black tracking-tighter">
            0
          </h2>
        </div>
      </div>

      <div class="grid lg:grid-cols-2 gap-8">
        <div class="glass-card p-10 rounded-[3.5rem] shadow-sm">
          <div class="flex items-center space-x-4 mb-8">
            <div
              class="w-12 h-12 bg-blue-100 text-blue-600 rounded-2xl flex items-center justify-center"
            >
              <i class="fas fa-file-excel text-xl"></i>
            </div>
            <div>
              <h2
                class="font-black text-blue-900 uppercase text-xs tracking-widest"
              >
                Data Extraction
              </h2>
              <p class="text-slate-400 text-[9px] mt-0.5">
                Generate universal .xlsx business reports.
              </p>
            </div>
          </div>
          <button
            onclick="exportToExcel()"
            class="w-full bg-blue-900 text-white py-6 rounded-2xl font-black uppercase text-[10px] tracking-[0.2em] hover:bg-orange-500 transition-all shadow-lg flex items-center justify-center"
          >
            <i class="fas fa-download mr-3"></i> Export Business Report
          </button>
        </div>

        <div class="glass-card p-10 rounded-[3.5rem] shadow-sm">
          <div class="flex items-center space-x-4 mb-8">
            <div
              class="w-12 h-12 bg-orange-100 text-orange-600 rounded-2xl flex items-center justify-center"
            >
              <i class="fas fa-database text-xl"></i>
            </div>
            <div>
              <h2
                class="font-black text-blue-900 uppercase text-xs tracking-widest"
              >
                Universal Restore
              </h2>
              <p class="text-slate-400 text-[9px] mt-0.5">
                Inject JSON metadata into Atlas cluster.
              </p>
            </div>
          </div>
          <input
            type="file"
            id="importFile"
            class="hidden"
            accept=".json"
            onchange="importBackup(event)"
          />
          <button
            onclick="document.getElementById('importFile').click()"
            class="w-full border-2 border-dashed border-slate-200 py-6 rounded-2xl text-slate-400 hover:border-orange-500 hover:text-orange-500 transition-all flex items-center justify-center font-black uppercase text-[10px] tracking-widest"
          >
            <i class="fas fa-upload mr-3"></i> Upload Restore File
          </button>
        </div>
      </div>

      <div
        class="mt-12 bg-red-50 p-10 rounded-[3.5rem] border border-red-100 flex flex-col md:flex-row items-center justify-between gap-6"
      >
        <div class="text-center md:text-left">
          <h2
            class="font-black text-red-600 uppercase text-xs tracking-[0.2em]"
          >
            Maintenance: Global Wipe
          </h2>
          <p class="text-red-400 text-[10px] font-medium mt-1 uppercase">
            Permanently purge all MongoDB product collections.
          </p>
        </div>
        <button
          onclick="deleteAllProducts()"
          class="bg-red-600 text-white px-10 py-5 rounded-2xl font-black text-[10px] uppercase tracking-widest hover:bg-black transition-all shadow-xl"
        >
          <i class="fas fa-radiation-alt mr-2"></i> Wipe Shop
        </button>
      </div>
    </div>

    <script>
      const API_BASE = "https://mishra-industries-ltd-yjfr.onrender.com";

      async function loadAnalytics() {
        const statusNode = document.querySelector(".bg-white span");

        try {
          const response = await fetch(
            `${API_BASE}/api/orders/stats/total-sales`,
          );
          const stats = await response.json();

          if (stats.success) {
            document.getElementById("totalRevenue").innerText =
              `₹${stats.totalRevenue.toLocaleString("en-IN")}`;
            document.getElementById("totalOrders").innerText =
              stats.totalOrders;

            statusNode.innerText = "Atlas Connected";
            statusNode.previousElementSibling.classList.replace(
              "bg-orange-500",
              "bg-green-500",
            );
          }

          const prodRes = await fetch(`${API_BASE}/api/products/all`);
          const products = await prodRes.json();
          document.getElementById("totalProducts").innerText = products.length;
        } catch (err) {
          console.error("Stats Sync Error:", err);
          statusNode.innerText = "Atlas Offline";
          statusNode.previousElementSibling.classList.replace(
            "bg-green-500",
            "bg-red-500",
          );
        }
      }

      // EXCEL EXPORT WITH SL NO COLUMN
      async function exportToExcel() {
        const btn = event.target.closest("button");
        btn.innerHTML =
          '<i class="fas fa-sync fa-spin mr-2"></i> Generating XLSX...';

        try {
          const [prodRes, orderRes] = await Promise.all([
            fetch(`${API_BASE}/api/products/all`),
            fetch(`${API_BASE}/api/orders/all`),
          ]);

          const products = await prodRes.json();
          const orders = await orderRes.json();
          const wb = XLSX.utils.book_new();

          // Inventory Sheet with Sl No.
          const cleanProds = products.map((p, index) => ({
            "Sl No.": index + 1, // Added Sl No column
            Product_ID: p._id,
            Name: p.name,
            Category: p.category,
            Company: p.company || "N/A",
            Price: p.price,
            Stock: p.stock,
            Discount: p.discount || 0
          }));
          
          XLSX.utils.book_append_sheet(
            wb,
            XLSX.utils.json_to_sheet(cleanProds),
            "Inventory",
          );

          // Sales Sheet with Sl No.
          const cleanOrders = orders.map((o, index) => ({
            "Sl No.": index + 1, // Added Sl No column
            Order_ID: o._id,
            Customer: o.customerName,
            Total: `₹${o.totalAmount}`,
            Status: o.status,
            Date: new Date(o.createdAt).toLocaleDateString(),
          }));

          XLSX.utils.book_append_sheet(
            wb,
            XLSX.utils.json_to_sheet(cleanOrders),
            "Sales",
          );

          XLSX.writeFile(
            wb,
            `Mishra_Report_${new Date().toLocaleDateString().replace(/\//g, '-')}.xlsx`,
          );
          
          btn.innerHTML = '<i class="fas fa-check mr-2"></i> Download Ready';
          setTimeout(
            () =>
              (btn.innerHTML =
                '<i class="fas fa-download mr-3"></i> Export Business Report'),
            3000,
          );
        } catch (err) {
          console.error(err);
          alert("Export Failed.");
        }
      }

      async function deleteAllProducts() {
        if (!confirm("Wipe all products?")) return;
        if (prompt("Type 'DELETE' to confirm:") !== "DELETE") return;
        try {
          const res = await fetch(
            `${API_BASE}/api/products/danger/delete-all`,
            { method: "DELETE" },
          );
          const data = await res.json();
          alert(`Success: ${data.count} items deleted.`);
          loadAnalytics();
        } catch (err) {
          alert("Wipe failed.");
        }
      }

      async function importBackup(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const json = JSON.parse(e.target.result);
            const res = await fetch(`${API_BASE}/api/products/backup/import`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(json),
            });
            const result = await res.json();
            alert(`Imported ${result.count} products.`);
            loadAnalytics();
          } catch (err) {
            alert("Import Failed.");
          }
        };
        reader.readAsText(file);
      }

      document.addEventListener("DOMContentLoaded", loadAnalytics);
    </script>
    <script>
      function handleLogout() {
        localStorage.removeItem("adminToken");
        localStorage.removeItem("adminAuthenticated");
        localStorage.removeItem("adminUser");
        localStorage.removeItem("Mishra_Session");
        document.body.classList.add("fade-out");
        setTimeout(() => {
          window.location.href = "../index.html";
        }, 500);
      }
    </script>
  </body>
</html>